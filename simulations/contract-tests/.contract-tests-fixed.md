# Contract Tests Fixed - SimV1 Schema Compliance

## What Was Wrong

The original contract tests used an incorrect format that didn't comply with the SimV1 schema specification.

### Key Issues Fixed:

1. **Missing `to:` reference** - Out steps didn't specify which connection to use
2. **Incorrect path specification** - Used `uri:` instead of `insert` with `type: Path`
3. **Wrong validation keyword** - Used `validate` instead of `verify`
4. **Incorrect status code format** - Used `statusCode:` instead of `property: StatusCode`
5. **Missing step names** - Steps didn't have descriptive `name` attributes

## Files Fixed

### 1. books-api-tests.yaml
**Before**: Invalid format with `uri:` and `validate`
**After**: Valid SimV1 format with 6 test services
- Uses `to: bookstore-api` for connection
- Uses `insert` with `type: Path` for URL paths
- Uses `verify` array for response validation
- Uses `property: StatusCode` for status codes

### 2. claude-api-tests.yaml
**Before**: Invalid format with `uri:` and `validate`
**After**: Valid SimV1 format with 2 test services
- Tests success case (200 OK)
- Tests rate limit error (429)
- Properly validates JSON response structure

### 3. llm-providers-tests.yaml
**Before**: Invalid format with `connection:` in message
**After**: Valid SimV1 format with 5 test services
- OpenAI Chat Completions
- Ollama Generate
- Ollama Chat
- Bedrock Invoke
- Bedrock Streaming

### 4. README.md
**Before**: Documented incorrect format
**After**: Complete documentation with:
- Correct SimV1 schema examples
- Common mistakes to avoid
- Port configuration table
- Debugging tips

### 5. .validation-notes.md (NEW)
Quick reference for SimV1 schema format with:
- Schema requirements
- Out/In step formats
- Common mistakes checklist

## Testing the Fixes

To verify the contract tests work:

```bash
# 1. Start Aspire with API Simulator
cd BookStore.Aspire.AppHost && dotnet run

# 2. Open Simulator UI
open http://localhost:28880/ui/

# 3. Navigate to Contract Tests section

# 4. Load and run test files from simulations/contract-tests/
```

## SimV1 Format Reference

### Correct Format:
```yaml
schema: SimV1
name: test-name

connections:
  - name: api
    endpoint: http://localhost:port
    listen: false

services:
  - name: test_service
    description: Description
    steps:
      - direction: Out
        name: sendRequest
        to: api
        message:
          method: POST
          headers:
            - key: Content-Type
              value: application/json
          payload: |-
            {"field": "value"}
        insert:
          - type: Path
            value: /api/endpoint
      
      - direction: In
        name: receiveResponse
        verify:
          - property: StatusCode
            value: 200 OK
          - jsonPath: field
            value: expected
```

### What Changed:
| Old (Incorrect) | New (Correct) |
|----------------|---------------|
| `uri: /path` | `insert: [type: Path, value: /path]` |
| `validate:` | `verify:` |
| `statusCode: 200` | `property: StatusCode, value: 200 OK` |
| No `to:` | `to: connection-name` |
| No `name:` on steps | `name: descriptive-name` |

## Files Created/Modified

**Modified:**
- `simulations/contract-tests/books-api-tests.yaml` - Completely rewritten
- `simulations/contract-tests/claude-api-tests.yaml` - Completely rewritten
- `simulations/contract-tests/llm-providers-tests.yaml` - Completely rewritten
- `simulations/contract-tests/README.md` - Updated with correct documentation

**Created:**
- `simulations/contract-tests/.validation-notes.md` - Quick reference guide
- `simulations/contract-tests/.contract-tests-fixed.md` - This summary

## References

- **Schema**: `simulations/iris_schema.json`
- **Examples**: `/Users/j.stennett/TAIS/hub-service/Tricentis.AI.Hub.EventSimulator/Simulations/contract-tests/aiHubServiceTests.yml`

All tests now conform to the SimV1 schema and should run successfully in the API Simulator UI.
